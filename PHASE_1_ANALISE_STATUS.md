# Phase 1 - An√°lise de Status e Pr√≥ximos Passos

**Data**: 2025-10-16  
**Refer√™ncia**: `plan/feature-platform-implementation-1.md`

---

## üìä Status Atual Phase 1

### ‚úÖ Completado (7/13 tasks - 54%)

| Task | Descri√ß√£o | Status | Arquivos | Notas |
|------|-----------|--------|----------|-------|
| **TASK-0100** | Model User + Argon2 | ‚úÖ 100% | `db/models/user.py`<br>`core/security/password.py` | Hash Argon2id configurado |
| **TASK-0101** | JWT utils + refresh | ‚úÖ 100% | `core/security/jwt.py` | Rotation implementado |
| **TASK-0102** | Endpoints auth | ‚úÖ 100% | `api/v1/routes/auth.py`<br>`api/v1/schemas/auth.py` | 4 endpoints: register, login, refresh, me |
| **TASK-0103** | Models entidades | ‚úÖ 100% | `db/models/salon.py`<br>`db/models/professional.py`<br>`db/models/service.py`<br>`db/models/availability.py`<br>`db/models/booking.py` | 5 modelos + relacionamentos |
| **TASK-0105** | Migra√ß√£o Alembic | ‚úÖ 100% | `alembic/versions/891c705f503c_*.py` | 7 tabelas criadas |
| **TASK-0109** | RBAC decorator | ‚úÖ 100% | `core/security/rbac.py` | 6 helpers + endpoint /me |
| **TASK-0110** | OpenAPI docs | üîÑ 50% | Swagger em `/docs` | Apenas Auth documentado |

### üîÑ Em Progresso (1/13 tasks - 8%)

| Task | Descri√ß√£o | Status | Faltando |
|------|-----------|--------|----------|
| **TASK-0104** | Reposit√≥rios | üîÑ 15% | Apenas `user.py` existe.<br>Faltam: salon, professional, service, availability, booking |

### ‚è≥ Pendente (5/13 tasks - 38%)

| Task | Descri√ß√£o | Prioridade | Estimativa | Depend√™ncias |
|------|-----------|------------|------------|--------------|
| **TASK-0106** | Slot calculation service | üî¥ Alta | 4-6h | TASK-0104 (repos) |
| **TASK-0107** | Endpoint buscar slots | üî¥ Alta | 2-3h | TASK-0106 |
| **TASK-0108** | Endpoint criar reserva | üî¥ Alta | 3-4h | TASK-0104, TASK-0107 |
| **TASK-0111** | Testes unit√°rios | üü° M√©dia | 4-5h | TASK-0106 |
| **TASK-0112** | Testes integra√ß√£o | üü° M√©dia | 5-6h | TASK-0108 |

---

## üéØ Plano de A√ß√£o para Finalizar Phase 1

### Estrat√©gia Recomendada

**Ordem de Execu√ß√£o** (baseada em depend√™ncias):

```mermaid
graph TD
    A[TASK-0104: Reposit√≥rios] --> B[TASK-0106: Slot Service]
    B --> C[TASK-0107: Endpoint Slots]
    C --> D[TASK-0108: Endpoint Booking]
    D --> E[TASK-0111: Testes Unit√°rios]
    E --> F[TASK-0112: Testes Integra√ß√£o]
    F --> G[Phase 1 Completa ‚úÖ]
```

### 1Ô∏è‚É£ **TASK-0104: Completar Reposit√≥rios** (Pr√≥xima)

**Objetivo**: Criar repositories para todas as entidades

**Arquivos a criar**:
- `backend/app/db/repositories/salon.py`
- `backend/app/db/repositories/professional.py`
- `backend/app/db/repositories/service.py`
- `backend/app/db/repositories/availability.py`
- `backend/app/db/repositories/booking.py`

**Template de Repository** (seguir padr√£o do `user.py`):
```python
class SalonRepository:
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create(...) -> Salon: ...
    async def get_by_id(id: int) -> Salon | None: ...
    async def list(...) -> list[Salon]: ...
    async def update(...) -> Salon: ...
    async def delete(id: int) -> bool: ...
    # M√©todos espec√≠ficos do dom√≠nio
```

**Crit√©rios de Conclus√£o**:
- [ ] 5 repositories criados
- [ ] M√©todos CRUD b√°sicos em cada um
- [ ] Type hints completos
- [ ] Docstrings em todas as fun√ß√µes

**Estimativa**: 3-4 horas

---

### 2Ô∏è‚É£ **TASK-0106: Slot Calculation Service**

**Objetivo**: Implementar l√≥gica de c√°lculo de hor√°rios dispon√≠veis

**Arquivo**: `backend/app/domain/scheduling/services/slot_service.py`

**Funcionalidades Principais**:

1. **`calculate_available_slots()`**
   - Input: professional_id, date, service_duration
   - Buscar availability do profissional para a data
   - Buscar bookings existentes
   - Calcular gaps livres
   - Retornar lista de slots dispon√≠veis

2. **`check_slot_conflict()`**
   - Verificar se um slot est√° dispon√≠vel
   - Considerar bookings existentes
   - Considerar hor√°rio de funcionamento

3. **Regras de Neg√≥cio**:
   - Respeitar hor√°rio de funcionamento do sal√£o
   - Considerar bloqueios do profissional
   - N√£o permitir overlap de reservas
   - Buffer entre servi√ßos (configur√°vel)

**Estrutura**:
```python
from datetime import date, time, datetime, timedelta
from backend.app.db.models.availability import Availability
from backend.app.db.models.booking import Booking, BookingStatus

class SlotService:
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def calculate_available_slots(
        self,
        professional_id: int,
        date: date,
        service_duration: int,  # minutes
        buffer_minutes: int = 0
    ) -> list[dict]:
        """
        Calculate available time slots for a professional.
        
        Returns:
            List of dicts with {start_time, end_time, duration}
        """
        # 1. Get professional availability for date
        # 2. Get existing bookings
        # 3. Calculate free gaps
        # 4. Generate slots of service_duration
        ...
```

**Crit√©rios de Conclus√£o**:
- [ ] Fun√ß√£o principal implementada
- [ ] L√≥gica de gaps funcionando
- [ ] Respeita availability + bookings
- [ ] Docstrings completas

**Estimativa**: 4-6 horas

---

### 3Ô∏è‚É£ **TASK-0107: Endpoint Buscar Slots**

**Objetivo**: Endpoint REST para buscar hor√°rios dispon√≠veis

**Arquivo**: `backend/app/api/v1/routes/scheduling.py` (novo)

**Endpoint**: `GET /v1/scheduling/slots`

**Query Parameters**:
- `professional_id` (required)
- `date` (required, format: YYYY-MM-DD)
- `service_id` (required, para pegar duration)

**Response**:
```json
{
  "professional_id": 1,
  "date": "2025-10-17",
  "service_duration": 60,
  "available_slots": [
    {"start_time": "09:00", "end_time": "10:00"},
    {"start_time": "10:00", "end_time": "11:00"},
    {"start_time": "14:00", "end_time": "15:00"}
  ]
}
```

**Crit√©rios de Conclus√£o**:
- [ ] Endpoint criado e registrado no router
- [ ] Schema Pydantic para request/response
- [ ] Valida√ß√µes de input
- [ ] RBAC: qualquer usu√°rio autenticado
- [ ] Documenta√ß√£o OpenAPI

**Estimativa**: 2-3 horas

---

### 4Ô∏è‚É£ **TASK-0108: Endpoint Criar Reserva**

**Objetivo**: Endpoint REST para criar reservas (bookings)

**Arquivo**: `backend/app/api/v1/routes/bookings.py` (novo)

**Endpoints**:

1. **POST /v1/bookings** - Criar reserva
   - RBAC: CLIENT
   - Input: service_id, professional_id, scheduled_at, notes
   - Validar slot dispon√≠vel
   - Criar booking com status PENDING
   - Retornar booking criado

2. **GET /v1/bookings** - Listar reservas
   - RBAC: Todos autenticados
   - Filtros por role:
     - CLIENT: apenas pr√≥prias reservas
     - PROFESSIONAL: reservas atribu√≠das a ele
     - SALON_OWNER: reservas do sal√£o
     - ADMIN: todas

3. **GET /v1/bookings/{id}** - Detalhes
   - RBAC: Validar acesso conforme role

4. **PATCH /v1/bookings/{id}/status** - Atualizar status
   - RBAC: PROFESSIONAL ou STAFF
   - Transi√ß√µes v√°lidas: PENDING ‚Üí CONFIRMED ‚Üí IN_PROGRESS ‚Üí COMPLETED

5. **DELETE /v1/bookings/{id}** - Cancelar
   - RBAC: CLIENT (pr√≥prias) ou STAFF
   - Marcar como CANCELLED

**Schemas Pydantic**:
```python
class BookingCreateRequest(BaseModel):
    service_id: int
    professional_id: int
    scheduled_at: datetime
    notes: str | None = None

class BookingResponse(BaseModel):
    id: int
    client_id: int
    professional_id: int
    service_id: int
    scheduled_at: datetime
    duration_minutes: int
    status: BookingStatus
    service_price: Decimal
    notes: str | None
    created_at: datetime
    updated_at: datetime
```

**Regras de Neg√≥cio**:
- Verificar slot dispon√≠vel antes de criar
- Snapshot do pre√ßo do servi√ßo
- Cliente s√≥ pode ter 1 reserva PENDING por vez (configur√°vel)

**Crit√©rios de Conclus√£o**:
- [ ] 5 endpoints implementados
- [ ] RBAC aplicado corretamente
- [ ] Valida√ß√µes de neg√≥cio
- [ ] Schemas completos
- [ ] Documenta√ß√£o OpenAPI

**Estimativa**: 3-4 horas

---

### 5Ô∏è‚É£ **TASK-0111: Testes Unit√°rios**

**Objetivo**: Testar fun√ß√µes isoladas (sem DB)

**Arquivos**: `tests/unit/`

**Cobertura M√≠nima**:

1. **`tests/unit/test_password.py`**
   - Hashing Argon2
   - Verify password
   - Needs rehash

2. **`tests/unit/test_jwt.py`**
   - Token generation
   - Token verification
   - Token expiration
   - Invalid tokens

3. **`tests/unit/test_slot_service.py`**
   - Calculate gaps
   - Handle overlaps
   - Edge cases (in√≠cio/fim do dia)
   - Buffer entre slots

4. **`tests/unit/test_rbac.py`**
   - Role validations
   - Permission checks

**Crit√©rios de Conclus√£o**:
- [ ] ‚â•80% coverage das fun√ß√µes testadas
- [ ] Testes passando
- [ ] Fixtures organizados

**Estimativa**: 4-5 horas

---

### 6Ô∏è‚É£ **TASK-0112: Testes de Integra√ß√£o**

**Objetivo**: Testar fluxos completos end-to-end

**Arquivos**: `tests/integration/`

**Cen√°rios**:

1. **`test_auth_flow.py`**
   - Register ‚Üí Login ‚Üí Access protected endpoint ‚Üí Refresh token

2. **`test_booking_flow.py`**
   - Create salon ‚Üí Create professional ‚Üí Create service
   - Set availability ‚Üí Search slots ‚Üí Create booking
   - Update booking status ‚Üí Cancel booking

3. **`test_rbac_permissions.py`**
   - Test each role's access to endpoints
   - Verify denial of unauthorized access

**Setup**:
- Database de teste (fixture)
- Seed data inicial
- Cleanup ap√≥s cada teste

**Crit√©rios de Conclus√£o**:
- [ ] 3+ cen√°rios cobertos
- [ ] Testes passando
- [ ] Fixtures reutiliz√°veis

**Estimativa**: 5-6 horas

---

## üìà M√©tricas de Conclus√£o Phase 1

### Checklist Final

- [ ] **Modelos**: 6 modelos SQLAlchemy com relacionamentos ‚úÖ
- [ ] **Migra√ß√£o**: Alembic migration aplicada ‚úÖ
- [ ] **Repositories**: 5 repositories CRUD completos
- [ ] **Autentica√ß√£o**: JWT + Argon2 + RBAC ‚úÖ
- [ ] **Endpoints Auth**: Register, Login, Refresh, Me ‚úÖ
- [ ] **Endpoints Scheduling**: Buscar slots
- [ ] **Endpoints Bookings**: CRUD completo de reservas
- [ ] **Domain Service**: SlotService com l√≥gica de c√°lculo
- [ ] **Testes Unit√°rios**: ‚â•80% coverage fun√ß√µes cr√≠ticas
- [ ] **Testes Integra√ß√£o**: ‚â•3 cen√°rios end-to-end
- [ ] **Documenta√ß√£o**: OpenAPI completa
- [ ] **Docker**: Todos os servi√ßos rodando ‚úÖ

### Issues GitHub Associadas

**Podem ser fechadas ap√≥s Phase 1**:
- ‚úÖ GH-001: Cadastro cliente
- ‚úÖ GH-002: Login autentica√ß√£o
- ‚úÖ GH-024: Gest√£o usu√°rios/permiss√µes (RBAC)
- ‚úÖ GH-026: Rate limiting
- ‚úÖ GH-041: Autentica√ß√£o JWT
- ‚è≥ GH-004: Cadastro sal√£o (modelo OK, faltam endpoints)
- ‚è≥ GH-005: Cadastro profissional (modelo OK, faltam endpoints)
- ‚è≥ GH-006: Cat√°logo servi√ßos (modelo OK, faltam endpoints)
- ‚è≥ GH-007: Disponibilidade (modelo OK, faltam endpoints)
- ‚è≥ GH-008: Buscar slots (aguardando TASK-0106/0107)
- ‚è≥ GH-009: Reservar servi√ßo (aguardando TASK-0108)

---

## ‚è±Ô∏è Timeline Estimado

| Task | Estimativa | Depend√™ncias |
|------|------------|--------------|
| TASK-0104 (Repositories) | 3-4h | Nenhuma ‚úÖ |
| TASK-0106 (Slot Service) | 4-6h | TASK-0104 |
| TASK-0107 (Endpoint Slots) | 2-3h | TASK-0106 |
| TASK-0108 (Endpoint Booking) | 3-4h | TASK-0104, TASK-0107 |
| TASK-0111 (Unit Tests) | 4-5h | TASK-0106 |
| TASK-0112 (Integration Tests) | 5-6h | TASK-0108 |
| **Total** | **21-28h** | |

**ETA para Phase 1 completa**: 3-4 dias √∫teis

---

## üöÄ Pr√≥xima A√ß√£o Imediata

### TASK-0104: Criar Repositories

**Start now**: Criar os 5 repositories faltantes seguindo o padr√£o do `UserRepository`.

**Ordem sugerida**:
1. `SalonRepository` (base, sem depend√™ncias)
2. `ProfessionalRepository` (depende de Salon + User)
3. `ServiceRepository` (depende de Salon)
4. `AvailabilityRepository` (depende de Professional)
5. `BookingRepository` (depende de User + Professional + Service)

**Template para come√ßar**:
```python
# backend/app/db/repositories/salon.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from backend.app.db.models.salon import Salon

class SalonRepository:
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def create(self, **kwargs) -> Salon:
        salon = Salon(**kwargs)
        self.db.add(salon)
        await self.db.commit()
        await self.db.refresh(salon)
        return salon
    
    async def get_by_id(self, salon_id: int) -> Salon | None:
        result = await self.db.execute(
            select(Salon).where(Salon.id == salon_id)
        )
        return result.scalar_one_or_none()
    
    # ... mais m√©todos
```

---

**√öltima Atualiza√ß√£o**: 2025-10-16 18:10 UTC  
**Progresso**: 54% (7/13) ‚Üí **Target**: 100% (13/13)  
**Pr√≥xima Task**: TASK-0104 - Repositories üöÄ
